<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>[foo]</title>

	<script type="text/js-worker">

		onmessage = function(e) {
			fetch(e.data)
				.then(function(response) {
					var reader = response.body.getReader();
					var decoder = new TextDecoder();
					var encoder = new TextEncoder("utf-8");
					var remainder = "";

					function readChunk() {
						return reader.read().then(processChunks);
					}

					function processChunks(result) {
						var chunk = decoder.decode(result.value || new Uint8Array, { stream: !result.done });
						chunk = remainder + chunk;
						var messages = chunk.split('\n');
						for (var i = 0; i < messages.length - 1; ++i) {
							var encoded = encoder.encode(messages[i]).buffer;
							self.postMessage(encoded, [encoded]);
						}
						remainder = messages[messages.length - 1];

						if (!result.done) {
							return readChunk();
						} else {
							return 0;
						}
					}

					return readChunk();
				});
		}
	</script>
	<script>
		function createFeatureView(model) {
			var template = document.querySelector('#featureTemplate');
			var div = template.content.querySelector("div");
			div.innerHTML = model.Name.NameFormat;
			containerCtrl.appendChild(document.importNode(template.content, true));
		}
	</script>
	<script>
		var items = {};

		function addItem(model, view) { items[model.RuntimeId] = { model: model, view: view }; }

		function findItem(model) { return items[model.RuntimeId]; }

		var eventProcessor = {};
		eventProcessor["FeatureStarted"] = function(model) {
			addItem(model, createFeatureView(model));
		};
	</script>
	<script>
		var containerCtrl = null;
		var rowTemplate = null;
		var templateDiv = null;

		function initializeWorker() {
			var blob = new Blob(Array.prototype.map.call(document.querySelectorAll('script[type=\'text\/js-worker\']'),
					function(s) { return s.textContent; }),
				{ type: 'text/javascript' });
			document.worker = new Worker(window.URL.createObjectURL(blob));
			var decoder = new TextDecoder();

			document.worker.onmessage = function(e) {
				var view = new DataView(e.data, 0, e.data.byteLength);
				var value = decoder.decode(view);
				try {
					var event = JSON.parse(value);
				} catch (xxx) {
					console.log(xxx);
				}
				var processor = eventProcessor[event.t];
				if (processor) {
					processor(event);
				}
			};
		}

		function initializeControls() {
			containerCtrl = document.getElementById("container");
		}

		function initialize() {
			initializeControls();
			initializeWorker();

			document.worker.postMessage(document.URL.slice(0, document.URL.lastIndexOf('/')) + "/progress.jsonl");
		}
	</script>
</head>

<body onload="initialize()">
<template id="featureTemplate">
	<div></div>
</template>

<div id="container">
</div>
</body>

</html>